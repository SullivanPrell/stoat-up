# Ansible Configuration for Stoat Deployment

This directory contains Ansible playbooks and configuration for deploying and configuring Stoat on OCI instances.

## Files

- `playbook.yml` - Main deployment playbook
- `ansible.cfg` - Ansible configuration (reads from environment variables)
- `inventory.ini.example` - Example inventory file
- `vars.yml.example` - Example variables file (deprecated - use .env instead)

## What the Playbook Does

The Ansible playbook automates the following tasks:

1. **System Updates**: Updates all packages and applies security patches
2. **Security Hardening**:
   - Configures UFW firewall (SSH, HTTP, HTTPS)
   - Installs and enables fail2ban
   - Ensures SSH password authentication is disabled
3. **Docker Installation**: Installs Docker CE and Docker Compose
4. **Application Deployment**:
   - Clones the Stoat repository
   - Generates configuration with your domain
   - Creates necessary directories
   - Starts all services with Docker Compose

## Prerequisites

1. **Instance Ready**: OCI instance provisioned (via Terraform or manually)
2. **SSH Access**: SSH key with access to the instance
3. **Ansible Installed**: Ansible >= 2.9
   ```bash
   # Ubuntu/Debian
   sudo apt install ansible
   
   # macOS
   brew install ansible
   
   # pip
   pip install ansible
   ```
4. **Domain Configured**: DNS A record pointing to instance IP
5. **Environment Variables**: `.env` file configured

## Quick Start

**Recommended: Use Make commands**

From the repository root:

```bash
# Ensure .env is configured
source .env

# Test connectivity
make ansible-ping

# Deploy
make ansible-deploy
```

**Alternative: Manual approach**

```bash
# Load environment
source ../.env

# Test connectivity
ansible stoat -m ping

# Run playbook
ansible-playbook playbook.yml
```

## Configuration Options

### Environment Variables

The playbook reads configuration from environment variables set in the `.env` file:

- `STOAT_DOMAIN` - Your domain name for Stoat
- `STOAT_DIR` - Installation directory (default: `/opt/stoat`)
- `ANSIBLE_USER` - SSH user (default: `ubuntu`)
- `ANSIBLE_SSH_PRIVATE_KEY` - Path to SSH private key

The `ansible.cfg` file automatically uses these environment variables.

### Inventory File

The `inventory.ini` file specifies the target server(s). It's auto-generated by Terraform, or you can create it manually:

```ini
[stoat]
xxx.xxx.xxx.xxx
```

### Legacy Configuration

The `vars.yml.example` file is provided for reference but is no longer the recommended approach. Use the `.env` file instead.

## Running the Playbook

All commands assume you've loaded the `.env` file:

```bash
source .env  # or source ../.env if in ansible directory
```

### Using Make (Recommended)

```bash
make ansible-ping     # Test connectivity
make ansible-deploy   # Full deployment
```

### Manual Execution

```bash
# Basic deployment
ansible-playbook playbook.yml

# With custom domain (overrides .env)
ansible-playbook playbook.yml -e "domain_name=custom.domain.com"

# Verbose output
ansible-playbook playbook.yml -vvv

# Dry run
ansible-playbook playbook.yml --check
```

## Post-Deployment

After the playbook completes:

1. **Access Stoat**: Navigate to `https://your.domain.com`
2. **Check logs**: 
   ```bash
   ssh ubuntu@<instance-ip>
   cd /opt/stoat
   docker compose logs -f
   ```
3. **Verify services**:
   ```bash
   docker compose ps
   ```

## Maintenance Playbooks

### Update Stoat

Create `update.yml`:

```yaml
---
- name: Update Stoat
  hosts: stoat
  become: yes
  tasks:
    - name: Pull latest code
      git:
        repo: https://github.com/SullivanPrell/stoat-up.git
        dest: /opt/stoat
        version: main
        force: yes

    - name: Pull latest images
      command: docker compose pull
      args:
        chdir: /opt/stoat

    - name: Restart services
      command: docker compose up -d
      args:
        chdir: /opt/stoat
```

Run with:
```bash
ansible-playbook update.yml
```

### Backup Data

Create `backup.yml`:

```yaml
---
- name: Backup Stoat Data
  hosts: stoat
  become: yes
  vars:
    backup_dest: "/backup/stoat-{{ ansible_date_time.iso8601_basic_short }}"
  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dest }}"
        state: directory

    - name: Backup database
      command: docker compose exec -T database mongodump --archive
      args:
        chdir: /opt/stoat
      register: mongodump_output

    - name: Save database backup
      copy:
        content: "{{ mongodump_output.stdout }}"
        dest: "{{ backup_dest }}/mongodb.archive"

    - name: Backup configuration
      copy:
        src: "/opt/stoat/{{ item }}"
        dest: "{{ backup_dest }}/"
        remote_src: yes
      loop:
        - Revolt.toml
        - .env.web
```

## Troubleshooting

### Connection Issues

```bash
# Test SSH connectivity
ssh -i ~/.ssh/stoat_oci_rsa ubuntu@<instance-ip>

# Test Ansible connectivity
ansible stoat -m ping --private-key ~/.ssh/stoat_oci_rsa
```

### Permission Denied

Ensure your SSH key is correct and has proper permissions:
```bash
chmod 600 ~/.ssh/stoat_oci_rsa
```

### Playbook Fails on Docker Installation

ARM instances (VM.Standard.A1.Flex) use aarch64 architecture. The playbook automatically handles this.

If issues persist:
```bash
# SSH into the instance
ssh -i ~/.ssh/stoat_oci_rsa ubuntu@<instance-ip>

# Manually install Docker
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker ubuntu
```

### Services Don't Start

1. Check Docker:
   ```bash
   sudo systemctl status docker
   ```

2. Check logs:
   ```bash
   cd /opt/stoat
   docker compose logs
   ```

3. Verify configuration:
   ```bash
   cat /opt/stoat/Revolt.toml
   cat /opt/stoat/.env.web
   ```

## Customization

### Different Installation Directory

```bash
ansible-playbook playbook.yml \
  -e "domain_name=your.domain.com" \
  -e "stoat_dir=/home/ubuntu/stoat"
```

### Skip Certain Tasks

Use tags (need to add to playbook):

```yaml
tasks:
  - name: Task name
    ...
    tags: ['setup', 'security']
```

Then run:
```bash
ansible-playbook playbook.yml --skip-tags security
```

## Advanced Usage

### Multiple Servers

Add more hosts to inventory:

```ini
[stoat]
server1.example.com
server2.example.com

[stoat:vars]
ansible_user=ubuntu
```

### Use Ansible Vault for Secrets

```bash
# Create encrypted vars
ansible-vault create secrets.yml

# Run with vault
ansible-playbook playbook.yml --ask-vault-pass -e "@secrets.yml"
```

## Next Steps

See the main [DEPLOYMENT.md](../DEPLOYMENT.md) for:
- Complete deployment guide
- DNS configuration
- SSL setup
- Monitoring and maintenance
- Troubleshooting tips

## Support

For issues specific to:
- **Ansible**: Check the Ansible documentation
- **Stoat**: See the main repository
- **OCI**: Consult OCI documentation
